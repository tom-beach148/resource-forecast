<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resource Forecast | Finance & Resourcing</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            min-height: 100vh;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            font-family: 'DM Sans', -apple-system, sans-serif;
            color: #e2e8f0;
        }
        .card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            backdrop-filter: blur(20px);
            transition: all 0.3s ease;
        }
        .card:hover {
            border-color: rgba(148, 163, 184, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .stat-card {
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-color), transparent);
        }
        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        }
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .input-field {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            color: #e2e8f0;
            font-size: 14px;
            width: 100%;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        .input-field:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .table-row:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        .tag {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .mono {
            font-family: 'JetBrains Mono', monospace;
        }
        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #64748b;
        }
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-in {
            animation: slideIn 0.3s ease forwards;
        }
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    {% raw %}
    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback, useRef } = React;

        // Simple SVG Icons
        const PlusIcon = () => (<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>);
        const TrashIcon = () => (<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>);
        const RefreshIcon = () => (<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>);
        const XIcon = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>);
        const CloudIcon = () => (<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>);
        const TrendingUpIcon = () => (<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>);
        const DollarIcon = () => (<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>);
        const PercentIcon = () => (<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="19" y1="5" x2="5" y2="19"></line><circle cx="6.5" cy="6.5" r="2.5"></circle><circle cx="17.5" cy="17.5" r="2.5"></circle></svg>);
        const UsersIcon = () => (<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>);

        const BUSINESS_UNITS = ['DBU', 'SBU', 'TBU'];
        const POLL_INTERVAL = 60000; // 60 seconds

        // Generate rolling 12 months from current month
        function getRollingMonths() {
            const months = [];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const now = new Date();
            
            for (let i = 0; i < 12; i++) {
                const date = new Date(now.getFullYear(), now.getMonth() + i, 1);
                const monthName = monthNames[date.getMonth()];
                const year = date.getFullYear().toString().slice(-2); // Get last 2 digits
                months.push({
                    label: monthName + ' ' + year,
                    month: date.getMonth(),
                    year: date.getFullYear()
                });
            }
            return months;
        }
        
        const ROLLING_MONTHS = getRollingMonths();

        // Helper function to parse dates in multiple formats
        function parseDate(dateStr) {
            if (!dateStr) return null;
            // Try YYYY-MM-DD format first
            if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                return new Date(dateStr);
            }
            // Try DD/MM/YYYY format
            if (dateStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                const [day, month, year] = dateStr.split('/');
                return new Date(year, month - 1, day);
            }
            // Try to parse anyway
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? null : d;
        }

        const BU_COLORS = { DBU: '#10b981', SBU: '#6366f1', TBU: '#f59e0b' };
        const STAT_ICONS = { revenue: TrendingUpIcon, cost: DollarIcon, margin: PercentIcon, associates: UsersIcon };

        // Chart Component using Chart.js - creates once, updates smoothly
        function ForecastChart({ data }) {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            // Create chart only once on mount
            useEffect(() => {
                if (!chartRef.current) return;
                
                const ctx = chartRef.current.getContext('2d');
                chartInstance.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Cost',
                                data: [],
                                backgroundColor: 'rgba(245, 158, 11, 0.5)',
                                borderColor: '#f59e0b',
                                borderWidth: 2,
                                borderRadius: 4,
                                order: 2
                            },
                            {
                                label: 'Margin',
                                data: [],
                                backgroundColor: 'rgba(16, 185, 129, 0.5)',
                                borderColor: '#10b981',
                                borderWidth: 2,
                                borderRadius: 4,
                                order: 1
                            },
                            {
                                label: 'Margin %',
                                data: [],
                                type: 'line',
                                borderColor: '#6366f1',
                                backgroundColor: '#6366f1',
                                borderWidth: 3,
                                pointRadius: 5,
                                pointBackgroundColor: '#6366f1',
                                yAxisID: 'y1',
                                order: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false,
                        interaction: { intersect: false, mode: 'index' },
                        plugins: {
                            legend: {
                                labels: { color: '#94a3b8', font: { family: 'DM Sans' } }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                                titleColor: '#e2e8f0',
                                bodyColor: '#e2e8f0',
                                borderColor: 'rgba(148, 163, 184, 0.2)',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        if (context.dataset.label === 'Margin %') {
                                            return context.dataset.label + ': ' + context.raw + '%';
                                        }
                                        return context.dataset.label + ': £' + context.raw.toLocaleString();
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { 
                                    color: '#64748b',
                                    maxRotation: 45,
                                    minRotation: 45
                                },
                                grid: { color: 'rgba(148, 163, 184, 0.1)' }
                            },
                            y: {
                                ticks: { 
                                    color: '#64748b',
                                    callback: function(value) { return '£' + value / 1000 + 'K'; }
                                },
                                grid: { color: 'rgba(148, 163, 184, 0.1)' }
                            },
                            y1: {
                                position: 'right',
                                ticks: { 
                                    color: '#64748b',
                                    callback: function(value) { return value + '%'; }
                                },
                                grid: { display: false }
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                        chartInstance.current = null;
                    }
                };
            }, []); // Empty dependency - only run once

            // Update data whenever it changes
            useEffect(() => {
                if (!chartInstance.current) return;
                
                chartInstance.current.data.labels = data.map(d => d.month);
                chartInstance.current.data.datasets[0].data = data.map(d => d.cost);
                chartInstance.current.data.datasets[1].data = data.map(d => d.margin);
                chartInstance.current.data.datasets[2].data = data.map(d => d.marginPercent);
                chartInstance.current.update('none');
            }, [data]);

            return <canvas ref={chartRef}></canvas>;
        }

        function App() {
            const [associates, setAssociates] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);
            const [lastSync, setLastSync] = useState(null);
            const [error, setError] = useState(null);
            const [failCount, setFailCount] = useState(0);
            const [formData, setFormData] = useState({
                name: '', businessUnit: 'DBU', startDate: '', endDate: '',
                numberOfDays: '', perDiem: '', costRate: ''
            });

            const fetchAssociates = useCallback(async (showLoadingState = false, retryCount = 0) => {
                if (showLoadingState) setLoading(true);
                try {
                    const response = await fetch('/api/associates');
                    if (!response.ok) throw new Error('Failed to fetch');
                    const data = await response.json();
                    
                    // Check if it's an error response
                    if (data.error) throw new Error(data.error);
                    
                    setAssociates(data);
                    setLastSync(new Date());
                    setError(null);
                    setFailCount(0); // Reset fail count on success
                } catch (err) {
                    console.error('Fetch error:', err);
                    
                    // Retry up to 2 times with increasing delay
                    if (retryCount < 2) {
                        const delay = (retryCount + 1) * 2000; // 2s, 4s
                        console.log('Retrying in ' + delay + 'ms...');
                        setTimeout(() => fetchAssociates(false, retryCount + 1), delay);
                        return;
                    }
                    
                    // Only show error after 3 consecutive failures
                    setFailCount(prev => {
                        if (prev >= 2) {
                            setError('Connection to Google Sheets lost. Retrying...');
                        }
                        return prev + 1;
                    });
                    // Keep existing data - don't clear associates
                } finally {
                    setLoading(false);
                }
            }, []);

            useEffect(() => {
                fetchAssociates(true);
                const interval = setInterval(() => fetchAssociates(false), POLL_INTERVAL);
                return () => clearInterval(interval);
            }, [fetchAssociates]);

            const resetForm = () => {
                setFormData({ name: '', businessUnit: 'DBU', startDate: '', endDate: '', numberOfDays: '', perDiem: '', costRate: '' });
                setEditingId(null);
                setShowForm(false);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setSaving(true);
                try {
                    const url = editingId ? '/api/associates/' + editingId : '/api/associates';
                    const method = editingId ? 'PUT' : 'POST';
                    await fetch(url, {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    await fetchAssociates(false);
                    resetForm();
                } catch (err) {
                    setError('Failed to save');
                } finally {
                    setSaving(false);
                }
            };

            const handleEdit = (associate) => {
                setFormData({
                    name: associate.name,
                    businessUnit: associate.businessUnit,
                    startDate: associate.startDate,
                    endDate: associate.endDate,
                    numberOfDays: associate.numberOfDays,
                    perDiem: associate.perDiem,
                    costRate: associate.costRate
                });
                setEditingId(associate.id);
                setShowForm(true);
            };

            const handleDelete = async (id) => {
                if (!confirm('Are you sure you want to delete this associate?')) return;
                setSaving(true);
                try {
                    await fetch('/api/associates/' + id, { method: 'DELETE' });
                    await fetchAssociates(false);
                } catch (err) {
                    setError('Failed to delete');
                } finally {
                    setSaving(false);
                }
            };

            const forecastData = useMemo(() => {
                return ROLLING_MONTHS.map((monthData) => {
                    const monthStart = new Date(monthData.year, monthData.month, 1);
                    const monthEnd = new Date(monthData.year, monthData.month + 1, 0);

                    let totalRevenue = 0, totalCost = 0;
                    const buBreakdown = {};

                    associates.forEach(assoc => {
                        const start = parseDate(assoc.startDate);
                        const end = parseDate(assoc.endDate);

                        if (!start || !end) return; // Skip invalid dates

                        if (start <= monthEnd && end >= monthStart) {
                            // Count how many of the 12 months this associate is active
                            let activeMonths = 0;
                            ROLLING_MONTHS.forEach(m => {
                                const mStart = new Date(m.year, m.month, 1);
                                const mEnd = new Date(m.year, m.month + 1, 0);
                                if (start <= mEnd && end >= mStart) activeMonths++;
                            });

                            const daysThisMonth = activeMonths > 0 ? Number(assoc.numberOfDays) / activeMonths : 0;
                            const revenue = daysThisMonth * Number(assoc.perDiem);
                            const cost = daysThisMonth * Number(assoc.costRate);

                            totalRevenue += revenue;
                            totalCost += cost;

                            if (!buBreakdown[assoc.businessUnit]) {
                                buBreakdown[assoc.businessUnit] = { revenue: 0, cost: 0, headcount: 0 };
                            }
                            buBreakdown[assoc.businessUnit].revenue += revenue;
                            buBreakdown[assoc.businessUnit].cost += cost;
                            buBreakdown[assoc.businessUnit].headcount += 1;
                        }
                    });

                    return {
                        month: monthData.label,
                        revenue: Math.round(totalRevenue),
                        cost: Math.round(totalCost),
                        margin: Math.round(totalRevenue - totalCost),
                        marginPercent: totalRevenue > 0 ? Math.round(((totalRevenue - totalCost) / totalRevenue) * 100) : 0,
                        buBreakdown
                    };
                });
            }, [associates]);

            const totals = useMemo(() => {
                const totalRevenue = forecastData.reduce((sum, m) => sum + m.revenue, 0);
                const totalCost = forecastData.reduce((sum, m) => sum + m.cost, 0);
                const totalMargin = totalRevenue - totalCost;
                const avgMarginPercent = totalRevenue > 0 ? Math.round((totalMargin / totalRevenue) * 100) : 0;
                return { totalRevenue, totalCost, totalMargin, avgMarginPercent };
            }, [forecastData]);

            const buSummary = useMemo(() => {
                const summary = {};
                forecastData.forEach(month => {
                    Object.entries(month.buBreakdown).forEach(([bu, data]) => {
                        if (!summary[bu]) summary[bu] = { revenue: 0, cost: 0, margin: 0 };
                        summary[bu].revenue += data.revenue;
                        summary[bu].cost += data.cost;
                        summary[bu].margin += (data.revenue - data.cost);
                    });
                });
                return Object.entries(summary).map(([bu, data]) => ({
                    name: bu, ...data,
                    marginPercent: data.revenue > 0 ? Math.round((data.margin / data.revenue) * 100) : 0
                }));
            }, [forecastData]);

            const formatCurrency = (val) => {
                if (val >= 1000000) return '£' + (val / 1000000).toFixed(1) + 'M';
                if (val >= 1000) return '£' + (val / 1000).toFixed(0) + 'K';
                return '£' + val;
            };

            const statCards = [
                { label: 'Total Revenue', value: formatCurrency(totals.totalRevenue), icon: 'revenue', color: '#10b981', sub: '12-month forecast' },
                { label: 'Total Cost', value: formatCurrency(totals.totalCost), icon: 'cost', color: '#f59e0b', sub: 'Labour costs' },
                { label: 'Gross Margin', value: formatCurrency(totals.totalMargin), icon: 'margin', color: '#6366f1', sub: totals.avgMarginPercent + '% margin' },
                { label: 'Active Associates', value: associates.length, icon: 'associates', color: '#ec4899', sub: 'Current headcount' },
            ];

            if (loading) {
                return (
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', minHeight: '100vh', flexDirection: 'column', gap: 16 }}>
                        <div className="loading-spinner" style={{ width: 40, height: 40, borderWidth: 3 }}></div>
                        <p style={{ color: '#64748b' }}>Connecting to Google Sheets...</p>
                    </div>
                );
            }

            return (
                <div style={{ padding: '24px', maxWidth: '1400px', margin: '0 auto' }}>
                    <header style={{ marginBottom: 32, display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', flexWrap: 'wrap', gap: 16 }}>
                        <div>
                            <h1 style={{ fontSize: 32, fontWeight: 700, margin: 0, background: 'linear-gradient(135deg, #e2e8f0, #94a3b8)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>Resource Forecast</h1>
                            <p style={{ color: '#64748b', marginTop: 4, fontSize: 14 }}>Finance & Resourcing Planning • 12-Month Rolling Forecast</p>
                            <div className="sync-indicator" style={{ marginTop: 8 }}>
                                <CloudIcon />
                                <div className="sync-dot" style={{ background: failCount > 0 ? '#f59e0b' : '#10b981' }}></div>
                                <span>{failCount > 0 ? 'Reconnecting...' : 'Synced with Google Sheets'} {lastSync && '• ' + lastSync.toLocaleTimeString()}</span>
                            </div>
                        </div>
                        <div style={{ display: 'flex', gap: 12, alignItems: 'center' }}>
                            <button onClick={() => fetchAssociates(false)} style={{ background: 'rgba(99, 102, 241, 0.2)', border: 'none', padding: 10, borderRadius: 8, color: '#6366f1', cursor: 'pointer' }} title="Refresh now">
                                <RefreshIcon />
                            </button>
                            <button className="btn-primary" onClick={() => setShowForm(true)} disabled={saving}>
                                <PlusIcon /> Add Associate
                            </button>
                        </div>
                    </header>

                    {error && (
                        <div style={{ background: 'rgba(245, 158, 11, 0.2)', border: '1px solid rgba(245, 158, 11, 0.3)', borderRadius: 8, padding: 12, marginBottom: 24, color: '#fcd34d', fontSize: 14, display: 'flex', alignItems: 'center', gap: 8 }}>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                            {error} (showing cached data)
                        </div>
                    )}

                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))', gap: 20, marginBottom: 32 }}>
                        {statCards.map((stat, i) => {
                            const IconComponent = STAT_ICONS[stat.icon];
                            return (
                                <div key={i} className="card stat-card" style={{ padding: 24, '--accent-color': stat.color }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                        <div>
                                            <p style={{ color: '#64748b', fontSize: 13, marginBottom: 8, textTransform: 'uppercase', letterSpacing: '0.5px' }}>{stat.label}</p>
                                            <p className="mono" style={{ fontSize: 28, fontWeight: 600, margin: 0, color: stat.color }}>{stat.value}</p>
                                            <p style={{ color: '#475569', fontSize: 12, marginTop: 4 }}>{stat.sub}</p>
                                        </div>
                                        <div style={{ background: stat.color + '20', padding: 10, borderRadius: 12, color: stat.color }}><IconComponent /></div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))', gap: 20, marginBottom: 32 }}>
                        <div className="card" style={{ padding: 24 }}>
                            <h3 style={{ margin: '0 0 20px', fontSize: 16, fontWeight: 600, color: '#94a3b8' }}>12-Month Cost Forecast & Margin Analysis</h3>
                            <div style={{ height: 320 }}>
                                <ForecastChart data={forecastData} />
                            </div>
                        </div>

                        <div className="card" style={{ padding: 24 }}>
                            <h3 style={{ margin: '0 0 20px', fontSize: 16, fontWeight: 600, color: '#94a3b8' }}>Margin by Business Unit</h3>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
                                {buSummary.length === 0 ? (
                                    <p style={{ color: '#64748b', fontSize: 14 }}>No data yet. Add associates to see breakdown.</p>
                                ) : buSummary.map((bu, i) => (
                                    <div key={i} style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                                        <div style={{ width: 10, height: 10, borderRadius: '50%', background: BU_COLORS[bu.name] || '#6366f1' }} />
                                        <div style={{ flex: 1 }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                                                <span style={{ fontSize: 13, fontWeight: 500 }}>{bu.name}</span>
                                                <span className="mono" style={{ fontSize: 13, color: '#10b981' }}>{bu.marginPercent}%</span>
                                            </div>
                                            <div style={{ height: 6, background: 'rgba(148, 163, 184, 0.1)', borderRadius: 3, overflow: 'hidden' }}>
                                                <div style={{ width: bu.marginPercent + '%', height: '100%', background: 'linear-gradient(90deg, ' + BU_COLORS[bu.name] + ', ' + BU_COLORS[bu.name] + '80)', borderRadius: 3, transition: 'width 0.5s ease' }} />
                                            </div>
                                            <p className="mono" style={{ fontSize: 11, color: '#64748b', marginTop: 4 }}>{formatCurrency(bu.margin)} margin • {formatCurrency(bu.cost)} cost</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="card" style={{ padding: 24 }}>
                        <h3 style={{ margin: '0 0 20px', fontSize: 16, fontWeight: 600, color: '#94a3b8', display: 'flex', alignItems: 'center', gap: 8 }}>
                            <UsersIcon /> Associate Resources
                        </h3>
                        <div style={{ overflowX: 'auto' }}>
                            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                <thead>
                                    <tr style={{ borderBottom: '1px solid rgba(148, 163, 184, 0.2)' }}>
                                        {['Name', 'Business Unit', 'Start Date', 'End Date', 'Days', 'Per Diem', 'Cost Rate', 'Actions'].map(h => (
                                            <th key={h} style={{ textAlign: 'left', padding: '12px 16px', fontSize: 11, color: '#64748b', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: 600 }}>{h}</th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {associates.length === 0 ? (
                                        <tr><td colSpan="8" style={{ padding: 40, textAlign: 'center', color: '#64748b' }}>No associates yet. Click "Add Associate" to get started.</td></tr>
                                    ) : associates.map(assoc => (
                                        <tr key={assoc.id} className="table-row" style={{ borderBottom: '1px solid rgba(148, 163, 184, 0.1)' }}>
                                            <td style={{ padding: '14px 16px', fontWeight: 500 }}>{assoc.name}</td>
                                            <td style={{ padding: '14px 16px' }}><span className="tag" style={{ background: (BU_COLORS[assoc.businessUnit] || '#6366f1') + '30', color: BU_COLORS[assoc.businessUnit] || '#6366f1' }}>{assoc.businessUnit}</span></td>
                                            <td className="mono" style={{ padding: '14px 16px', fontSize: 13 }}>{assoc.startDate}</td>
                                            <td className="mono" style={{ padding: '14px 16px', fontSize: 13 }}>{assoc.endDate}</td>
                                            <td className="mono" style={{ padding: '14px 16px', fontSize: 13 }}>{assoc.numberOfDays}</td>
                                            <td className="mono" style={{ padding: '14px 16px', fontSize: 13, color: '#10b981' }}>£{assoc.perDiem}/day</td>
                                            <td className="mono" style={{ padding: '14px 16px', fontSize: 13, color: '#f59e0b' }}>£{assoc.costRate}/day</td>
                                            <td style={{ padding: '14px 16px' }}>
                                                <div style={{ display: 'flex', gap: 8 }}>
                                                    <button onClick={() => handleEdit(assoc)} disabled={saving} style={{ background: 'rgba(99, 102, 241, 0.2)', border: 'none', padding: '6px 12px', borderRadius: 6, color: '#6366f1', cursor: saving ? 'not-allowed' : 'pointer', fontSize: 12, fontWeight: 500, opacity: saving ? 0.6 : 1 }}>Edit</button>
                                                    <button onClick={() => handleDelete(assoc.id)} disabled={saving} style={{ background: 'rgba(239, 68, 68, 0.2)', border: 'none', padding: '6px', borderRadius: 6, color: '#ef4444', cursor: saving ? 'not-allowed' : 'pointer', display: 'flex', alignItems: 'center', opacity: saving ? 0.6 : 1 }}><TrashIcon /></button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {showForm && (
                        <div style={{ position: 'fixed', inset: 0, background: 'rgba(0, 0, 0, 0.7)', backdropFilter: 'blur(4px)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => !saving && resetForm()}>
                            <div className="card animate-in" style={{ padding: 32, width: 480, maxHeight: '90vh', overflowY: 'auto' }} onClick={e => e.stopPropagation()}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24 }}>
                                    <h3 style={{ margin: 0, fontSize: 18, fontWeight: 600 }}>{editingId ? 'Edit Associate' : 'Add New Associate'}</h3>
                                    <button onClick={() => !saving && resetForm()} style={{ background: 'none', border: 'none', color: '#64748b', cursor: 'pointer', padding: 4 }}><XIcon /></button>
                                </div>
                                <form onSubmit={handleSubmit}>
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
                                        <div>
                                            <label style={{ display: 'block', fontSize: 12, color: '#94a3b8', marginBottom: 6, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Full Name</label>
                                            <input className="input-field" type="text" value={formData.name} onChange={e => setFormData({ ...formData, name: e.target.value })} placeholder="John Smith" required />
                                        </div>
                                        <div>
                                            <label style={{ display: 'block', fontSize: 12, color: '#94a3b8', marginBottom: 6, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Business Unit</label>
                                            <select className="input-field" value={formData.businessUnit} onChange={e => setFormData({ ...formData, businessUnit: e.target.value })} style={{ cursor: 'pointer' }}>
                                                {BUSINESS_UNITS.map(bu => (<option key={bu} value={bu}>{bu}</option>))}
                                            </select>
                                        </div>
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
                                            <div>
                                                <label style={{ display: 'block', fontSize: 12, color: '#94a3b8', marginBottom: 6, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Start Date</label>
                                                <input className="input-field" type="date" value={formData.startDate} onChange={e => setFormData({ ...formData, startDate: e.target.value })} required />
                                            </div>
                                            <div>
                                                <label style={{ display: 'block', fontSize: 12, color: '#94a3b8', marginBottom: 6, textTransform: 'uppercase', letterSpacing: '0.5px' }}>End Date</label>
                                                <input className="input-field" type="date" value={formData.endDate} onChange={e => setFormData({ ...formData, endDate: e.target.value })} required />
                                            </div>
                                        </div>
                                        <div>
                                            <label style={{ display: 'block', fontSize: 12, color: '#94a3b8', marginBottom: 6, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Number of Days</label>
                                            <input className="input-field" type="number" min="1" value={formData.numberOfDays} onChange={e => setFormData({ ...formData, numberOfDays: e.target.value })} placeholder="100" required />
                                        </div>
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
                                            <div>
                                                <label style={{ display: 'block', fontSize: 12, color: '#94a3b8', marginBottom: 6, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Per Diem (£/day)</label>
                                                <input className="input-field" type="number" min="0" value={formData.perDiem} onChange={e => setFormData({ ...formData, perDiem: e.target.value })} placeholder="250" required />
                                            </div>
                                            <div>
                                                <label style={{ display: 'block', fontSize: 12, color: '#94a3b8', marginBottom: 6, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Cost Rate (£/day)</label>
                                                <input className="input-field" type="number" min="0" value={formData.costRate} onChange={e => setFormData({ ...formData, costRate: e.target.value })} placeholder="125" required />
                                            </div>
                                        </div>
                                        <button type="submit" className="btn-primary" style={{ marginTop: 8, justifyContent: 'center' }} disabled={saving}>
                                            {saving ? (<><div className="loading-spinner"></div>Saving...</>) : (editingId ? 'Update Associate' : 'Add Associate')}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    {% endraw %}
</body>
</html>
